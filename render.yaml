services:
  - type: web
    name: retail-brain-api-gateway
    env: docker
    dockerfilePath: ./services/api-gateway/Dockerfile
    dockerContext: .
    plan: free
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      - key: POSTGRES_HOST
        sync: false
      - key: POSTGRES_PORT
        sync: false
      - key: POSTGRES_DB
        sync: false
      - key: POSTGRES_USER
        sync: false
      - key: POSTGRES_PASSWORD
        sync: false
      - key: REDIS_HOST
        sync: false
      - key: REDIS_PORT
        sync: false
      - key: REDIS_PASSWORD
        sync: false
      - key: PROFILE_SERVICE_URL
        value: https://retail-brain-profile-service.onrender.com
      - key: IDENTITY_ENGINE_URL
        value: https://retail-brain-identity-engine.onrender.com
      - key: RECOMMENDER_SERVICE_URL
        value: https://retail-brain-recommender-service.onrender.com
      - key: API_GATEWAY_API_KEYS
        generateValue: true
        sync: false
      - key: EVENT_COLLECTOR_URL
        value: https://retail-brain-event-collector.onrender.com
      - key: LOG_LEVEL
        value: info

  - type: web
    name: retail-brain-event-collector
    env: docker
    dockerfilePath: ./services/event-collector/Dockerfile
    dockerContext: .
    plan: free
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: POSTGRES_HOST
        sync: false
      - key: POSTGRES_PORT
        sync: false
      - key: POSTGRES_DB
        sync: false
      - key: POSTGRES_USER
        sync: false
      - key: POSTGRES_PASSWORD
        sync: false
      - key: LOG_LEVEL
        value: info

  - type: web
    name: retail-brain-mlflow
    env: docker
    dockerImage: ghcr.io/mlflow/mlflow:v2.8.1
    plan: free
    envVars:
      - key: MLFLOW_BACKEND_STORE_URI
        sync: false
        # Format: postgresql://user:password@host:port/database
        # Set this manually after creating PostgreSQL
      - key: MLFLOW_DEFAULT_ARTIFACT_ROOT
        value: file:/mlflow/artifacts
    dockerCommand: >
      mlflow server
      --backend-store-uri $MLFLOW_BACKEND_STORE_URI
      --default-artifact-root $MLFLOW_DEFAULT_ARTIFACT_ROOT
      --host 0.0.0.0
      --port $PORT

